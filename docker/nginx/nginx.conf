events {
    worker_connections 1024;
}

http {
    # Upstream definitions
    upstream react_ui {
        server react-ui:80;
    }

    upstream backend_api {
        server backend:8080;
    }

    upstream strapi_cms {
        server strapi-cms:1337;
    }

    upstream tuddi_backend {
        server tuddi:3002;
    }

    upstream conduktor_backend {
        server conduktor:8080;
    }

    # Main website - React UI
    server {
        listen 80;
        server_name www.simonrowe.dev simonrowe.dev www.simonrowe.localhost simonrowe.localhost localhost;

        location / {
            proxy_pass http://react_ui;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # Backend API
    server {
        listen 80;
        server_name api.simonrowe.dev api.simonrowe.localhost;

        location / {
            proxy_pass http://backend_api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # Strapi CMS
    server {
        listen 80;
        server_name cms.simonrowe.dev cms.simonrowe.localhost;

        location / {
            proxy_pass http://strapi_cms;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # Tuddi Todo App
    server {
        listen 80;
        server_name todos.simonrowe.dev todos.simonrowe.localhost;

        location / {
            proxy_pass http://tuddi_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # Conduktor Kafka UI
    server {
        listen 80;
        server_name conduktor.simonrowe.dev conduktor.simonrowe.localhost;

        location / {
            proxy_pass http://conduktor_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # Default server block for other requests
    server {
        listen 80 default_server;
        server_name _;
        return 444;
    }
}
