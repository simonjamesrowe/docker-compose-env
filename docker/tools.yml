version: '3.8'

x-default-env-files: &default-env-files
  - ./config.env
  - ./.env

services:
  tuddi:
    image: chrisvel/tududi:latest
    container_name: tuddi
    ports:
      - "3002:3002"
    env_file: *default-env-files
    environment:
      - TUDUDI_USER_EMAIL=${TUDUDI_USER_EMAIL}
      - TUDUDI_USER_PASSWORD=${TUDUDI_USER_PASSWORD}
      - TUDUDI_SESSION_SECRET=${TUDUDI_SESSION_SECRET}
      - TUDUDI_INTERNAL_SSL_ENABLED=false
    volumes:
      - tududi_db:/usr/src/app/backend/db
    networks:
      - app-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.1'
          memory: 256M
        reservations:
          cpus: '0.07'
          memory: 179M

  conduktor:
    image: conduktor/conduktor-platform:latest
    container_name: conduktor
    ports:
      - "8088:8080"
    env_file: *default-env-files
    environment:
      CDK_ADMIN_EMAIL: ${CONDUKTOR_ADMIN_EMAIL:-admin@conduktor.io}
      CDK_ADMIN_PASSWORD: ${CONDUKTOR_ADMIN_PASSWORD:-admin}
      CDK_DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-conduktor}
      CDK_CLUSTERS_0_ID: local
      CDK_CLUSTERS_0_NAME: Local Kafka
      CDK_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9092
      CDK_CLUSTERS_0_SCHEMAREGISTRY_URL: ""
    volumes:
      - conduktor_data:/var/conduktor
    networks:
      - app-network
    restart: unless-stopped
    depends_on:
      kafka:
        condition: service_healthy
      postgres:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '0.4'
          memory: 1.5G
        reservations:
          cpus: '0.28'
          memory: 1.05G

volumes:
  tududi_db:
  conduktor_data:

networks:
  app-network:
    external: true
